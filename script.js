// Firebase„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™çÁî®Ôºà„Ç≥„É≥„ÇΩ„Éº„É´„Å´Ë°®Á§∫Ôºâ
console.log("Firebase DB:", db);

// „Éá„Éê„ÉÉ„Ç∞Áî®
console.log("Firebase loaded?", typeof firebase !== "undefined");
console.log("Database object:", db);


const MAP_ROWS = 9;
const MAP_COLUMNS = 18;

const HEX_CENTER_START_X = 147;
const HEX_CENTER_START_Y = 152;
const HEX_X_INTERVAL = 113;
const HEX_Y_INTERVAL = 151;

const blockedCells = [];

const initialPositions = {
  A: [1, 2, 3, 4, 5, 6, 7, 8, 9, 51, 56, 107, 112],
  B: [154, 155, 156, 157, 158, 159, 160, 161, 162, 51, 56, 107, 112]
};

let movingUnit = null;
let isMovingMode = false;

let selectedTeam = null;
let selectedUnit = null;

let sharedMissionsData = null;
let secretMissionsData = null;

const occupiedCells = new Set();
const occupiedUnits = new Set();

const sUnitCount = {
  "s_unit01.png": 0,
  "s_unit02.png": 0
};

const unitInstanceCount = {};
const teamPoints = { A: 0, B: 0 };

let playerInfo = null;

window.onload = () => {
  document.getElementById("logoutButton").style.display = "none";
  document.getElementById("resetButton").style.display = "none";
};

function login() {
  const team = document.getElementById("teamSelect").value;
  const name = document.getElementById("playerName").value.trim();
  const skill = parseInt(document.getElementById("skill").value);
  const reflex = parseInt(document.getElementById("reflex").value);
  const mind = parseInt(document.getElementById("mind").value);

  if (!name || isNaN(skill) || isNaN(reflex) || isNaN(mind)) {
    document.getElementById("loginError").textContent = "„Åô„Åπ„Å¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
    return;
  }

  if (
    skill < 1 || skill > 6 ||
    reflex < 1 || reflex > 6 ||
    mind < 1 || mind > 6
  ) {
    document.getElementById("loginError").textContent = "ÊäÄËÉΩ„ÉªÂèçÂøú„ÉªÁ≤æÁ•û„ÅØ1„Äú6„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
    return;
  }

  if (skill + reflex + mind !== 12) {
    document.getElementById("loginError").textContent = "ÊäÄËÉΩ„ÉªÂèçÂøú„ÉªÁ≤æÁ•û„ÅÆÂêàË®à„ÅØ12„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
    return;
  }

  document.getElementById("loginError").textContent = "";

  // ‚úÖ „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„Çí„Åì„Åì„Åß„Çª„ÉÉ„Éà
  playerInfo = { team, name, skill, reflex, mind };

  // ‚úÖ „É≠„Éº„Ç´„É´ID„ÇíÁîüÊàê„Éª‰øùÂ≠ò
  const playerID = localStorage.getItem("playerID") || crypto.randomUUID();
  localStorage.setItem("playerID", playerID);

  // ‚úÖ Firebase„Å´„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±ÁôªÈå≤
  firebase.database().ref(`players/${playerID}`).set(playerInfo);

  // ‚úÖ Ë°®Á§∫Âàá„ÇäÊõø„Åà
  toggleGameUI(true);

  // ‚úÖ „É¶„Éã„ÉÉ„ÉàÈÅ∏Êäû„É™„Çπ„Éà„Å®„É©„Éô„É´Ë°®Á§∫
  renderUnitList("A");
  renderUnitList("B");
  showAllHexLabels();

  // ‚úÖ „ÉÅ„Éº„É†Âêç„ÅÆÂº∑Ë™øË°®Á§∫
  document.querySelector(`#${team === 'A' ? 'leftPanel' : 'rightPanel'} h2`)
    .classList.add(team === 'A' ? 'selected-a' : 'selected-b');

  // üîΩ Âá∫ÊíÉÈÅ∏Êäû„Çø„Ç§„Éà„É´„Çí„Éó„É¨„Ç§„É§„ÉºÂêç„Å´Â§âÊõ¥
  document.querySelector("#unitListA").previousElementSibling.textContent =
    team === "A" ? `Âá∫ÊíÉÈÅ∏ÊäûÔºà${name}Ôºâ` : "Âá∫ÊíÉÈÅ∏Êäû";
  document.querySelector("#unitListB").previousElementSibling.textContent =
    team === "B" ? `Âá∫ÊíÉÈÅ∏ÊäûÔºà${name}Ôºâ` : "Âá∫ÊíÉÈÅ∏Êäû";

  // ‚úÖ ÂàùÊúüÂåñ„Éï„É©„Ç∞„ÅÆÁõ£Ë¶ñ
  firebase.database().ref("resetFlag").on("value", snapshot => {
    if (snapshot.val()) {
      // ÔºàÁúÅÁï•ÔºâÂàùÊúüÂåñÂá¶ÁêÜ„ÅØ fetch Áõ£Ë¶ñ„Å®ÂêåÊßò
    }
  });

  // ‚úÖ ÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅÆ„Åø„Éü„ÉÉ„Ç∑„Éß„É≥ÂàùÊúüÂåñ„Åó„ÄÅ„Åù„ÅÆ„ÅÇ„Å®Ë°®Á§∫
  firebase.database().ref("missions").once("value", snapshot => {
    if (!snapshot.exists()) {
      initializeMissions();
    }
  
  });

  showSharedMissions();  // ‚Üê ÂâäÈô§„Åõ„Åö„Å´„Åì„Åì„ÅØÊÆã„Åô
  console.log("„É≠„Ç∞„Ç§„É≥ÂÆå‰∫Ü", playerInfo);

}

function toggleGameUI(isLoggedIn) {
  document.getElementById("loginArea").style.display = isLoggedIn ? "none" : "block";
  document.getElementById("gameArea").style.display = isLoggedIn ? "flex" : "none";
  document.getElementById("diceArea").style.display = isLoggedIn ? "block" : "none";

  document.getElementById("commonMissionArea").style.display = isLoggedIn ? "block" : "none";
  document.getElementById("teamMissionArea").style.display = isLoggedIn ? "block" : "none";

  document.getElementById("eventArea").style.display = isLoggedIn ? "block" : "none";

  document.getElementById("logoutButton").style.display = isLoggedIn ? "inline-block" : "none";
  document.getElementById("resetButton").style.display = isLoggedIn ? "inline-block" : "none";
}



function getHexPixelPosition(cellNumber) {
  const index = cellNumber - 1;
  const col = Math.floor(index / MAP_ROWS);
  const row = index % MAP_ROWS;
  const mapImage = document.getElementById("mapImage");
  const scale = mapImage.clientWidth / mapImage.naturalWidth;
  const yOffset = (col % 2 === 1) ? HEX_Y_INTERVAL / 2 : 0;
  const x = (HEX_CENTER_START_X + col * HEX_X_INTERVAL) * scale;
  const y = (HEX_CENTER_START_Y + row * HEX_Y_INTERVAL + yOffset) * scale;
  return { left: x, top: y };
}

function showAllHexLabels() {
  const container = document.getElementById("hexLabels");
  container.innerHTML = "";
  const totalCells = MAP_ROWS * MAP_COLUMNS;
  for (let cellNum = 1; cellNum <= totalCells; cellNum++) {
    if (blockedCells.includes(cellNum)) continue;
    const pos = getHexPixelPosition(cellNum);
    const label = document.createElement("div");
    label.className = "hexLabel";
    label.style.left = `${pos.left}px`;
    label.style.top = `${pos.top}px`;
    label.innerText = cellNum;
    label.dataset.cellnum = cellNum;
    label.onclick = () => handleHexClick(label);
    container.appendChild(label);
  }
}

function handleHexClick(label) {
  const clickedCellNum = Number(label.dataset.cellnum);
  if (isMovingMode && movingUnit) {
    if (!occupiedCells.has(clickedCellNum)) {
      moveUnitToCell(movingUnit, clickedCellNum);
      movingUnit = null;
      isMovingMode = false;
      clearMoveHighlights();
    }
    return;
  }
  if (!selectedUnit) return;
  const team = selectedTeam;
  const allowed = initialPositions[team];
  if (!allowed.includes(clickedCellNum)) return;
  if (occupiedCells.has(clickedCellNum)) return;
  placeUnitOnMap(clickedCellNum, selectedUnit);
  occupiedCells.add(clickedCellNum);
  removeUnitCard(selectedUnit);
  clearSelectedUnit();
}

function selectTeam(team) {
  selectedTeam = team;
  selectedUnit = null;
  clearSelectedUnit();
  renderUnitList(team);
}

function renderUnitList(team) {
  const container = document.getElementById(team === 'A' ? 'unitListA' : 'unitListB');
  container.innerHTML = "";
  const images = [
    team === "A" ? "s_unit01.png" : "s_unit02.png",
    ...Array.from({ length: 14 }, (_, i) => `unit${String(i + 1).padStart(2, '0')}.png`)
  ];
  for (const img of images) {
    if (/^unit\d{2}\.png$/.test(img) && occupiedUnits.has(img)) continue;
    const card = createUnitCard(img, team);
    container.appendChild(card);
  }
}

function clearSelectedUnit() {
  selectedUnit = null;
  document.querySelectorAll(".unitCard img").forEach(el => {
    el.classList.remove("selected-a", "selected-b");
  });
  document.querySelectorAll(".hexLabel").forEach(el => {
    el.classList.remove("allowed-a", "allowed-b");
  });
}

function createUnitCard(filename, team) {
  const wrapper = document.createElement("div");
  wrapper.className = "unitCard";
  wrapper.dataset.filename = filename;

  const img = document.createElement("img");
  img.src = `images/${filename}`;
  img.alt = filename;
  img.dataset.team = team;
  img.dataset.filename = filename;

  // ‚òÖ„Åì„Åì„Åß„ÉÅ„Éº„É†„ÉÅ„Çß„ÉÉ„ÇØ„ÇíËøΩÂä†
  img.addEventListener("click", () => {
    if (!playerInfo || playerInfo.team !== team) {
      alert("Ëá™ËªçÂÅ¥„ÅÆ„É¶„Éã„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      return;
    }

    clearSelectedUnit();
    selectedTeam = team;
    img.classList.add(team === "A" ? "selected-a" : "selected-b");
    selectedUnit = filename;
    highlightAllowedCells(team);
  });

  wrapper.appendChild(img);
  return wrapper;
}


function highlightAllowedCells(team) {
  document.querySelectorAll(".hexLabel").forEach(el => {
    el.classList.remove("allowed-a", "allowed-b");
  });
  const targets = initialPositions[team];
  for (const num of targets) {
    if (occupiedCells.has(num)) continue;
    const label = document.querySelector(`.hexLabel[data-cellnum="${num}"]`);
    if (label) {
      label.classList.add(team === "A" ? "allowed-a" : "allowed-b");
    }
  }
}

function placeUnitOnMap(cellNum, filename) {
  if (!cellNum || cellNum < 1 || cellNum > MAP_ROWS * MAP_COLUMNS) return;

  if (!unitInfo || !unitInfo[filename]) {
    alert("„É¶„Éã„ÉÉ„Éà„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    return;
  }

  const team = selectedTeam;

  // unitXX „ÅÆÂ†¥Âêà„ÅØÂá∫ÊíÉÊ∏à„Åø„Å®„Åó„Å¶Ë®òÈå≤
  if (/^unit\d{2}\.png$/.test(filename)) {
    occupiedUnits.add(filename);
  }

  occupiedCells.add(cellNum);
  removeUnitCard(filename);
  clearSelectedUnit();
  renderUnitList("A");
  renderUnitList("B");

  const safeFilename = filename.replace(/\./g, "_");
  const unitID = `${safeFilename}_${Date.now()}`;
  unitInstanceCount[unitID] = true;

  // üîΩ s_unit „ÅÆÂ†¥ÂêàÔºö„ÉÅ„Éº„É†Âçò‰Ωç„Åß Firebase ‰∏ä„ÅÆ„Ç´„Ç¶„É≥„Éà„Çí‰Ωø„Å£„Å¶‰øùÂ≠ò
  if (filename === "s_unit01.png" || filename === "s_unit02.png") {
    firebase.database().ref(`s_unitCounts/${team}`).transaction(current => {
      return (current || 0) + 1;
    }).then(result => {
      const count = result.snapshot.val();

      firebase.database().ref(`units/${unitID}`).set({
        unitID,
        filename,
        cellNum,
        team,
        playerName: playerInfo?.name || "unknown",
        count: count,  // ‚úÖ „Åì„Åì„ÅßÂÖ±Êúâ„Ç´„Ç¶„É≥„Éà„Çí‰Ωø„ÅÜ
        skill: playerInfo?.skill || 0,
        reflex: playerInfo?.reflex || 0,
        mind: playerInfo?.mind || 0,
        hp: unitInfo[filename]?.hp || 1
      });
    });
  } else {
    // unitXX „ÅØ„Ç´„Ç¶„É≥„Éà„Å™„Åó„Åß„Åù„ÅÆ„Åæ„Åæ‰øùÂ≠ò
    firebase.database().ref(`units/${unitID}`).set({
      unitID,
      filename,
      cellNum,
      team,
      playerName: playerInfo?.name || "unknown",
      count: 1,
      skill: playerInfo?.skill || 0,
      reflex: playerInfo?.reflex || 0,
      mind: playerInfo?.mind || 0,
      hp: unitInfo[filename]?.hp || 1
    });
  }
}

function removeUnitCard(filename) {
  if (/^unit\d{2}\.png$/.test(filename)) {
    const card = document.querySelector(`.unitCard[data-filename="${filename}"]`);
    if (card) card.remove();
  }
}

function clearUnitStatusPanels() {
  document.getElementById("unitStatusA").innerHTML = "";
  document.getElementById("unitStatusB").innerHTML = "";
}

function showUnitStatus(team, filename, count = null, playerData = null) {
  const info = unitInfo[filename];
  if (!info) return;

  let labelName = info.name;
  if ((filename === "s_unit01.png" || filename === "s_unit02.png") && count > 1) {
    labelName += `Ôºà${count}Ôºâ`;
  }

  const container = document.getElementById(team === 'A' ? 'unitStatusA' : 'unitStatusB');
  if (!container) return;

  const div = document.createElement('div');
  div.className = 'unitStatus';
  div.dataset.filename = filename;
  div.dataset.team = team;
  div.dataset.count = count || 1;

  const playerName = playerData?.playerName || "Ôºà‰∏çÊòéÔºâ";
  const skill = playerData?.skill ?? "-";
  const reflex = playerData?.reflex ?? "-";
  const mind = playerData?.mind ?? "-";

  const currentHP = playerData?.hp ?? info.hp;  // üîß „Åì„Åì„Çí‰øÆÊ≠£ÔºÅ

  div.innerHTML = `
    <div class="unitName">${labelName}
      <button onclick="deleteUnit(this)">ÂâäÈô§</button>
    </div>
    <div class="unitHP">
      ËÄê‰πÖÂÄ§ <span class="hp">${currentHP}</span>
      <button onclick="adjustHP(this, +1)">Ôºã</button>
      <button onclick="adjustHP(this, -1)">Ôºç</button>
    </div>
    <div class="playerInfo">${playerName}</div>
    <div class="playerStats">ÊäÄË°ì${skill} ÂèçÂøú${reflex} Á≤æÁ•û${mind}</div>
  `;
  container.appendChild(div);
}

function adjustHP(button, delta) {
  const hpSpan = button.parentElement.querySelector(".hp");
  let hp = parseInt(hpSpan.textContent);
  hp = Math.max(0, hp + delta);
  hpSpan.textContent = hp;

  const unitDiv = button.closest(".unitStatus");
  const filename = unitDiv.dataset.filename;
  const team = unitDiv.dataset.team;
  const count = parseInt(unitDiv.dataset.count);

  // Firebase„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã„É¶„Éã„ÉÉ„ÉàID„ÇíÊé¢„Åô
  firebase.database().ref("units").once("value").then(snapshot => {
    const allUnits = snapshot.val();
    for (const key in allUnits) {
      const u = allUnits[key];
      if (u && u.filename === filename && u.team === team && u.count === count) {
        firebase.database().ref(`units/${key}/hp`).set(hp);
        break;
      }
    }
  });
}

function deleteUnit(button) {
  const unitDiv = button.closest(".unitStatus");
  const filename = unitDiv.dataset.filename;
  const team = unitDiv.dataset.team;
  const count = parseInt(unitDiv.dataset.count);

  // ‚òÖ Ëá™Ëªç„ÅÆ„É¶„Éã„ÉÉ„Éà‰ª•Â§ñ„ÅØÂâäÈô§„Åß„Åç„Å™„ÅÑ
  if (!playerInfo || playerInfo.team !== team) {
    alert("Ëá™Ëªç„ÅÆ„É¶„Éã„ÉÉ„Éà„ÅÆ„ÅøÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ");
    return;
  }

  // „É¶„Éã„ÉÉ„ÉàÁîªÂÉè„ÇíÂâäÈô§
  const unitsOnMap = document.querySelectorAll(`.unitOnMap.${team.toLowerCase()}`);
  for (let unit of unitsOnMap) {
    if (unit.src.includes(filename)) {
      unit.remove();
      break;
    }
  }

  // „É©„Éô„É´ÂâäÈô§Ôºàs_unit „ÅÆÂ†¥ÂêàÔºâ
  if (filename === "s_unit01.png" || filename === "s_unit02.png") {
    const labels = document.querySelectorAll(".unitNumberLabel");
    for (let label of labels) {
      if (label.innerText === `Ôºà${count}Ôºâ`) {
        label.remove();
        break;
      }
    }
  }

  // occupiedCells „Åã„Çâ cellNum „ÇíÂâäÈô§ÔºàFirebase„Åã„Çâ‰ΩçÁΩÆÂèñÂæóÔºâ
  firebase.database().ref("units").once("value").then(snapshot => {
    const allUnits = snapshot.val();
    for (const key in allUnits) {
      const u = allUnits[key];
      if (u && u.filename === filename && u.team === team && u.count === count) {
        firebase.database().ref(`units/${key}`).remove();  // Firebase„Åã„ÇâÂâäÈô§
        occupiedCells.delete(u.cellNum);  // „É≠„Éº„Ç´„É´„Åã„ÇâÂâäÈô§
        break;
      }
    }
  });

  // „É¶„Éã„ÉÉ„ÉàÊÉÖÂ†±ÂâäÈô§
  unitDiv.remove();
  if (/^unit\d{2}\.png$/.test(filename)) {
    occupiedUnits.delete(filename);
    renderUnitList("A");
    renderUnitList("B");
  }
}


function clearMoveHighlights() {
  document.querySelectorAll(".hexLabel").forEach(label => {
    label.classList.remove("highlight-move");
    label.onclick = () => handleHexClick(label);
  });
}

function moveUnitToCell(unit, newCellNum) {
  if (!unit || !unit.unitID || !newCellNum) return;

  // üîΩ Firebase „Åã„ÇâÂÖÉ„ÅÆ cellNum „ÇíÂèñÂæó„Åó„Å¶„ÄÅoccupiedCells „Åã„ÇâÂâäÈô§
  firebase.database().ref(`units/${unit.unitID}/cellNum`).once("value", snapshot => {
    const oldCellNum = snapshot.val();
    if (oldCellNum) occupiedCells.delete(oldCellNum);  // ‚Üê ÂÖÉ„ÅÆ„Éû„Çπ„ÇíÁ©∫„Åç„Å´

    // üîΩ Êñ∞„Åó„ÅÑ‰ΩçÁΩÆ„Å´„É¶„Éã„ÉÉ„Éà„ÇíÁßªÂãï
    const pos = getHexPixelPosition(newCellNum);
    unit.img.style.left = `${pos.left}px`;
    unit.img.style.top = `${pos.top}px`;

    // üîΩ Êñ∞„Åó„ÅÑ„Éû„Çπ„Çí occupied „Å´ËøΩÂä†
    occupiedCells.add(newCellNum);

    // üîΩ Firebase „Å´„ÇÇÊõ¥Êñ∞
    firebase.database().ref(`units/${unit.unitID}/cellNum`).set(newCellNum);
  });
}


function getUnitIDFromImg(src) {
  const matches = src.match(/\/([^/]+)\.png/);
  const filename = matches ? matches[1].replace(/\./g, "_") : "unknown";
  const allKeys = Object.keys(unitInstanceCount);
  return allKeys.find(key => key.startsWith(filename));
}

function clearMoveMode() {
  movingUnit = null;
  isMovingMode = false;
  clearMoveHighlights();
}

function showSharedMissions() {
  firebase.database().ref("missions").on("value", snapshot => {
    sharedMissionsData = snapshot.val();
    renderMissions();
  });

  firebase.database().ref("secretMissions").on("value", snapshot => {
    secretMissionsData = snapshot.val();
    renderMissions();
  });
}


function renderMissions() {
  // ÂÖ±ÈÄö„Éü„ÉÉ„Ç∑„Éß„É≥ÊèèÁîªÂÖà
  const commonContainer = document.getElementById("commonMissions");
  commonContainer.innerHTML = "";
  if (sharedMissionsData) {
    sharedMissionsData.forEach((mission, index) => {
      const wrapper = createMissionCard(mission, index, "missions");
      commonContainer.appendChild(wrapper);
    });
  }

  // „ÉÅ„Éº„É†Âà•„Éü„ÉÉ„Ç∑„Éß„É≥ÊèèÁîªÂÖà
  const aContainer = document.getElementById("teamAMissions");
  const bContainer = document.getElementById("teamBMissions");
  aContainer.innerHTML = "";
  bContainer.innerHTML = "";

  if (!playerInfo) return;

  // AËªç„Éü„ÉÉ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´
  const aTitle = document.createElement("h4");
  if (secretMissionsData?.A) {
    aTitle.textContent = secretMissionsData.A.revealed ? "AËªçÔºàÂÖ¨ÈñãÔºâ" : "AËªçÔºàÈùûÂÖ¨ÈñãÔºâ";
  } else {
    aTitle.textContent = "AËªçÔºàÈùûÂÖ¨ÈñãÔºâ";
  }
  aContainer.appendChild(aTitle);

  // BËªç„Éü„ÉÉ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´
  const bTitle = document.createElement("h4");
  if (secretMissionsData?.B) {
    bTitle.textContent = secretMissionsData.B.revealed ? "BËªçÔºàÂÖ¨ÈñãÔºâ" : "BËªçÔºàÈùûÂÖ¨ÈñãÔºâ";
  } else {
    bTitle.textContent = "BËªçÔºàÈùûÂÖ¨ÈñãÔºâ";
  }
  bContainer.appendChild(bTitle);

  // AËªç„Éü„ÉÉ„Ç∑„Éß„É≥ÁîªÂÉèÔºàÊù°‰ª∂‰ªò„ÅçË°®Á§∫Ôºâ
  if (secretMissionsData?.A) {
    if (secretMissionsData.A.revealed || playerInfo.team === "A") {
      const aWrapper = createSecretMissionCard(secretMissionsData.A, "A", secretMissionsData.A.revealed);
      aContainer.appendChild(aWrapper);
    }
  }

  // BËªç„Éü„ÉÉ„Ç∑„Éß„É≥ÁîªÂÉèÔºàÊù°‰ª∂‰ªò„ÅçË°®Á§∫Ôºâ
  if (secretMissionsData?.B) {
    if (secretMissionsData.B.revealed || playerInfo.team === "B") {
      const bWrapper = createSecretMissionCard(secretMissionsData.B, "B", secretMissionsData.B.revealed);
      bContainer.appendChild(bWrapper);
    }
  }
}

function createMissionCard(mission, index, pathPrefix) {
  const wrapper = document.createElement("div");
  wrapper.className = "missionWrapper";

  const img = document.createElement("img");
  img.src = `images/mission/${mission.filename}`;
  img.className = "missionCard";

  const label = document.createElement("div");
  label.className = "clearLabel";
  label.innerText = "ÈÅîÊàêÊ∏à";
  label.style.display = mission.cleared ? "block" : "none";

  const buttonArea = document.createElement("div");
  buttonArea.className = "missionButtons";

  const clearBtn = document.createElement("button");
  clearBtn.innerText = "ÈÅîÊàê";
  clearBtn.onclick = () => {
    firebase.database().ref(`${pathPrefix}/${index}/cleared`).set(true);
  };

  const resetBtn = document.createElement("button");
  resetBtn.innerText = "Êàª„Åô";
  resetBtn.onclick = () => {
    firebase.database().ref(`${pathPrefix}/${index}/cleared`).set(false);
  };

  buttonArea.appendChild(clearBtn);
  buttonArea.appendChild(resetBtn);

  wrapper.appendChild(img);
  wrapper.appendChild(label);
  wrapper.appendChild(buttonArea);

  return wrapper;
}

function createSecretMissionCard(mission, team, isRevealed) {
  const wrapper = document.createElement("div");
  wrapper.className = "missionWrapper";

  const img = document.createElement("img");
  img.src = `images/mission/${mission.filename}`;
  img.className = "missionCard";
  // „Åì„Åì„Åß„ÇØ„É©„Çπ„Çí‰ªò„Åë„Çã
  img.classList.add(team === "A" ? "secret-a" : "secret-b");

  wrapper.appendChild(img);

  if (!isRevealed) {
    const buttonArea = document.createElement("div");
    buttonArea.className = "missionButtons";

    const revealBtn = document.createElement("button");
    revealBtn.innerText = "ÂÖ¨Èñã„Åô„Çã";
    revealBtn.onclick = () => {
      firebase.database().ref(`secretMissions/${team}/revealed`).set(true);
    };

    buttonArea.appendChild(revealBtn);
    wrapper.appendChild(buttonArea);
  }

  return wrapper;
}


function initializeMissions() {
  const all = Array.from({ length: 14 }, (_, i) =>
  `mission${String(i + 1).padStart(2, '0')}.png`
  );

  const shuffled = all.sort(() => 0.5 - Math.random());
  const common = shuffled.slice(0, 5);     // ÂÖ±ÈÄö5Êûö
  const secretA = shuffled[5];             // AËªç„ÅÆÁßòÂØÜ„Éü„ÉÉ„Ç∑„Éß„É≥
  const secretB = shuffled[6];             // BËªç„ÅÆÁßòÂØÜ„Éü„ÉÉ„Ç∑„Éß„É≥

  // ÂÖ±ÈÄö„Éü„ÉÉ„Ç∑„Éß„É≥„Çí‰øùÂ≠ò
  firebase.database().ref("missions").set(common.map(filename => ({
    filename,
    cleared: false
  })));

  // üîΩ ÁßòÂØÜ„Éü„ÉÉ„Ç∑„Éß„É≥„Çí‰øùÂ≠òÔºà‚Üê„Åì„Çå„ÅåËøΩÂä†„Åï„Çå„ÅüÈáçË¶Å„Éù„Ç§„É≥„ÉàÔºÅÔºâ
  firebase.database().ref("secretMissions").set({
    A: { filename: secretA, revealed: false },
    B: { filename: secretB, revealed: false }
  });
}


let unitInfo = {};

fetch('unit_data.json')
  .then(response => response.json())
  .then(data => {
    unitInfo = data;

    // „Éò„ÉÉ„ÇØ„Çπ„É©„Éô„É´Ë°®Á§∫
    showAllHexLabels();

    // „ÉÅ„Éº„É†A„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
    selectTeam('A');

    // „ÉÅ„Éº„É†B„ÅÆ„É¶„Éã„ÉÉ„Éà„É™„Çπ„Éà„ÇíË°®Á§∫
    renderUnitList('B');

    // „Éü„ÉÉ„Ç∑„Éß„É≥„ÇíË°®Á§∫
    showSharedMissions();

    // „É¶„Éã„ÉÉ„Éà„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü
    firebase.database().ref("units").on("value", snapshot => {
      const units = snapshot.val();
      updateUnitsFromFirebase(units);
    });

    // „Éù„Ç§„É≥„ÉàA„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ
    firebase.database().ref("points/A").on("value", snapshot => {
      const val = snapshot.val();
      if (val !== null) {
        teamPoints.A = val;
        document.getElementById("pointA").textContent = val;
      }
    });

    // „Éù„Ç§„É≥„ÉàB„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ
    firebase.database().ref("points/B").on("value", snapshot => {
      const val = snapshot.val();
      if (val !== null) {
        teamPoints.B = val;
        document.getElementById("pointB").textContent = val;
      }
    });

    // „É™„Çª„ÉÉ„Éà„Éï„É©„Ç∞Áõ£Ë¶ñÔºà„Ç≤„Éº„É†ÂàùÊúüÂåñÊôÇ„ÅÆÂá¶ÁêÜÔºâ
    firebase.database().ref("resetFlag").on("value", snapshot => {
      if (snapshot.val()) {
        alert("„Ç≤„Éº„É†„ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü„ÄÇÂÜç„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");

        // „É≠„Éº„Ç´„É´‰øùÂ≠ò„ÇØ„É™„Ç¢
        localStorage.removeItem("playerID");
        playerInfo = null;

        // Ë°®Á§∫„Çí„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Åô
        document.getElementById("loginArea").style.display = "block";
        document.getElementById("gameArea").style.display = "none";
        document.getElementById("diceArea").style.display = "none";
        document.getElementById("missionArea").style.display = "none";

        // ÁîªÈù¢„ÅÆÂàùÊúüÂåñ
        document.getElementById("unitLayer").innerHTML = "";
        document.getElementById("diceResult").textContent = "-";
        document.getElementById("rollButton").disabled = false;

        occupiedCells.clear();
        occupiedUnits.clear();

        renderUnitList("A");
        renderUnitList("B");

        // „Éï„É©„Ç∞ÂâäÈô§
        firebase.database().ref("resetFlag").remove();
      }
    });

  });


function adjustPoint(team, delta) {
  teamPoints[team] += delta;
  if (teamPoints[team] < 0) teamPoints[team] = 0;
  document.getElementById(`point${team}`).textContent = teamPoints[team];

  // ‚úÖ Firebase„Å´‰øùÂ≠ò
  firebase.database().ref(`points/${team}`).set(teamPoints[team]);
}


function rollDice() {
  const result = Math.floor(Math.random() * 6) + 1;
  const playerID = localStorage.getItem("playerID") || "unknown";

  // Firebase„Å´Âá∫ÁõÆ„Çí‰øùÂ≠ò
  firebase.database().ref("dice").set({
    value: result,
    rolledBy: playerID
  });

  // „Éú„Çø„É≥ÁÑ°ÂäπÂåñÔºàÂêåÊúüÂá¶ÁêÜ„Åß„ÇÇÂèçÊò†„Åï„Çå„Çã„ÅÆ„Åß„Åì„Åì„ÅßÊõ¥Êñ∞„Åó„Å™„Åè„Å¶„ÇÇ„Çà„ÅÑ„Åå‰∏ÄÂøúÔºâ
  document.getElementById("rollButton").disabled = true;
}

firebase.database().ref("dice").on("value", (snapshot) => {
  const data = snapshot.val();

  if (!data) {
    // üîÅ „É™„Çª„ÉÉ„Éà„Åï„Çå„Åü„Å®„ÅçÔºàÂÖ®Âì°„Å´ÂèçÊò†Ôºâ
    document.getElementById("diceResult").textContent = "-";
    document.getElementById("rollButton").disabled = false;
    return;
  }

  // üé≤ „Çµ„Ç§„Ç≥„É≠„ÇíÊåØ„Å£„Åü„Å®„ÅçÔºàÂÖ®Âì°„Å´Âá∫ÁõÆ„ÇíË°®Á§∫„Åó„ÄÅÂÜçÊåØ„Çä„ÇíÁ¶ÅÊ≠¢Ôºâ
  const result = data.value;
  document.getElementById("diceResult").textContent = result;
  document.getElementById("rollButton").disabled = true;
});


function resetDice() {
  firebase.database().ref("dice").set(null);  // Firebase„Åã„ÇâÂâäÈô§

  // „É≠„Éº„Ç´„É´ÁîªÈù¢„ÇíÂàùÊúüÂåñ
  document.getElementById("diceResult").textContent = "-";
  document.getElementById("rollButton").disabled = false;
}

function updateUnitsFromFirebase(units) {
  const containerA = document.getElementById("unitListA");
  const containerB = document.getElementById("unitListB");
  containerA.innerHTML = "";
  containerB.innerHTML = "";

  occupiedUnits.clear();
  occupiedCells.clear();
  document.getElementById("unitLayer").innerHTML = "";
  clearUnitStatusPanels();

  for (const key in units) {
    const u = units[key];
    if (!u || !u.team || !u.filename || !u.cellNum) continue;

    if (/^unit\d{2}\.png$/.test(u.filename)) {
      occupiedUnits.add(u.filename);
    }

    occupiedCells.add(u.cellNum);

    const pos = getHexPixelPosition(u.cellNum);
    const img = document.createElement("img");
    img.src = `images/${u.filename}`;
    img.className = `unitOnMap ${u.team.toLowerCase()}`;
    img.style.left = `${pos.left}px`;
    img.style.top = `${pos.top}px`;
    img.dataset.unitid = u.unitID || key;
    document.getElementById("unitLayer").appendChild(img);

    if ((u.filename === "s_unit01.png" || u.filename === "s_unit02.png") && u.count > 1) {
      const label = document.createElement("div");
      label.className = "unitNumberLabel";
      label.innerText = `Ôºà${u.count}Ôºâ`;
      label.style.left = `${pos.left}px`;
      label.style.top = `${pos.top - 20}px`;
      document.getElementById("unitLayer").appendChild(label);
    }

    // ‚úÖ „É¶„Éã„ÉÉ„Éà„Çí„ÇØ„É™„ÉÉ„ÇØ ‚Üí „Çµ„Ç§„Ç≥„É≠Êú™ÊåØ„Çä„Å™„ÇâÂÖ®„Éû„Çπ„ÄÅÊåØ„Å£„Å¶„ÅÇ„Çå„Å∞Âá∫ÁõÆ„ÅßÁØÑÂõ≤Âà∂Èôê
    img.addEventListener("click", () => {
      if (playerInfo && playerInfo.team !== u.team) return;

      const clickedUnitID = u.unitID || key;

      if (isMovingMode && movingUnit?.unitID === clickedUnitID) {
        clearMoveMode();
        return;
      }

      movingUnit = { img, filename: u.filename, unitID: clickedUnitID };
      isMovingMode = true;

      // üé≤ „Çµ„Ç§„Ç≥„É≠„ÅÆÂá∫ÁõÆ„ÇíÁ¢∫Ë™ç
      firebase.database().ref("dice/value").once("value").then(snapshot => {
        const rawDice = snapshot.val();

        if (rawDice === null) {
          // „Çµ„Ç§„Ç≥„É≠„ÇíÊåØ„Å£„Å¶„ÅÑ„Å™„ÅÑ ‚Üí ÂÖ®Á©∫„Åç„Éû„Çπ„Çí„Éè„Ç§„É©„Ç§„Éà
          document.querySelectorAll(".hexLabel").forEach(label => {
            const cell = Number(label.dataset.cellnum);
            label.classList.remove("highlight-move");

            if (!occupiedCells.has(cell) && !blockedCells.includes(cell)) {
              label.classList.add("highlight-move");
              label.onclick = () => {
                moveUnitToCell(movingUnit, cell);
                clearMoveMode();
              };
            } else {
              label.onclick = () => {
                clearMoveMode();
              };
            }
          });
        } else {
          // „Çµ„Ç§„Ç≥„É≠ÊåØ„Å£„Å¶„ÅÇ„Çã ‚Üí Âá∫ÁõÆ„Å´Âøú„Åò„ÅüÁßªÂãïÁØÑÂõ≤
          const diceVal = rawDice;
          const moveRange = unitInfo[u.filename]?.move?.[diceVal - 1] || 0;
          highlightMovableCells(u.cellNum, moveRange);
        }
      });
    });

    showUnitStatus(u.team, u.filename, u.count, u);
  }

  renderUnitList("A");
  renderUnitList("B");
}

function logout() {
  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÅÆÂâäÈô§
  localStorage.removeItem("playerID");
  playerInfo = null;

  // ‚úÖ Ë°®Á§∫ÂàáÊõøÔºàÂÖ±ÈÄöÈñ¢Êï∞„Çí‰ΩøÁî®Ôºâ
  toggleGameUI(false);
  document.getElementById("missionArea").innerHTML = "";

  // ÈÅ∏ÊäûÁä∂ÊÖã„ÅÆ„É™„Çª„ÉÉ„Éà
  selectedUnit = null;
  selectedTeam = null;
  clearSelectedUnit();

  // ‚úÖ Firebase„ÅÆ„É¶„Éã„ÉÉ„ÉàÁõ£Ë¶ñ„ÇíËß£Èô§Ôºà„Åì„Çå„Åå‰ªäÂõû„ÅÆ„Éù„Ç§„É≥„ÉàÔºÅÔºâ
  firebase.database().ref("units").off("value");
}


function resetGameData() {
  if (!confirm("Êú¨ÂΩì„Å´„Åô„Åπ„Å¶„ÅÆ„Éó„É¨„Ç§„É§„Éº„Å®„É¶„Éã„ÉÉ„ÉàÊÉÖÂ†±„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åô„ÅãÔºü")) return;

  firebase.database().ref("players").remove();
  firebase.database().ref("units").remove();
  firebase.database().ref("dice").remove();
  firebase.database().ref("points").remove();  // „Åì„Åì„Åß„Éù„Ç§„É≥„Éà„ÇÇÂâäÈô§
  firebase.database().ref("s_unitCounts").remove();
  firebase.database().ref("event").remove();  // „Ç§„Éô„É≥„Éà„Ç´„Éº„ÉâÁä∂ÊÖã„ÇíÂàùÊúüÂåñ

  initializeMissions();

  firebase.database().ref("resetFlag").set(true);

  alert("„Ç≤„Éº„É†„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü„ÄÇ");

  sUnitCount["s_unit01.png"] = 0;
  sUnitCount["s_unit02.png"] = 0;

  // „É≠„Éº„Ç´„É´„ÅÆ„Éù„Ç§„É≥„Éà„ÇÇ„É™„Çª„ÉÉ„Éà
  teamPoints.A = 0;
  teamPoints.B = 0;
  document.getElementById("pointA").textContent = "0";
  document.getElementById("pointB").textContent = "0";

  localStorage.removeItem("playerID");
  playerInfo = null;

  toggleGameUI(false);
  document.getElementById("unitLayer").innerHTML = "";
  document.getElementById("diceResult").textContent = "-";
  document.getElementById("rollButton").disabled = false;
  occupiedCells.clear();
  occupiedUnits.clear();
  renderUnitList("A");
  renderUnitList("B");
}


// üé¥ „Ç§„Éô„É≥„Éà„Ç´„Éº„ÉâÈñ¢ÈÄ£„ÅÆÁä∂ÊÖãÁõ£Ë¶ñ
firebase.database().ref("event").on("value", (snapshot) => {
  const data = snapshot.val();
  const container = document.getElementById("eventCardContainer");
  const triggerBtn = document.getElementById("eventTriggerBtn");
  const clearBtn = document.getElementById("eventClearBtn");

  container.innerHTML = "";

  if (!data || !data.current) {
    // Ë°®Á§∫„Å™„Åó
    triggerBtn.disabled = false;
    clearBtn.disabled = true;
  } else {
    // Ë°®Á§∫„ÅÇ„Çä
    const img = document.createElement("img");
    img.src = `images/event/${data.current}`;
    img.className = "eventCard";
    container.appendChild(img);
    triggerBtn.disabled = true;
    clearBtn.disabled = false;
  }
});

function triggerEvent() {
  firebase.database().ref("event").once("value").then(snapshot => {
    const data = snapshot.val() || {};
    const used = data.used || [];
    const allCards = Array.from({ length: 30 }, (_, i) => `event${String(i + 1).padStart(2, '0')}.png`);
    const remaining = allCards.filter(card => !used.includes(card));

    let nextCard;
    if (remaining.length === 0) {
      // „É™„Çª„ÉÉ„Éà„Åó„Å¶ÂÜç„Çπ„Çø„Éº„Éà
      nextCard = allCards[Math.floor(Math.random() * allCards.length)];
      firebase.database().ref("event").set({
        current: nextCard,
        used: [nextCard]
      });
    } else {
      // Êú™‰ΩøÁî®„Åã„Çâ„É©„É≥„ÉÄ„É†ÈÅ∏Êäû
      nextCard = remaining[Math.floor(Math.random() * remaining.length)];
      firebase.database().ref("event").set({
        current: nextCard,
        used: [...used, nextCard]
      });
    }
  });
}

function clearEvent() {
  firebase.database().ref("event/current").remove();
}

// „Éû„ÇπÁï™Âè∑„Çí (row, col) „Å´Â§âÊèõÔºàÁ∏¶9„Éû„Çπ √ó Ê®™18ÂàóÔºâ
function getCellCoordinates(cellNum) {
  const index = cellNum - 1;
  const col = Math.floor(index / MAP_ROWS);
  const row = index % MAP_ROWS;
  return { row, col };
}

// ÂÖ≠Ëßí„Éû„ÇπÂêåÂ£´„ÅÆË∑ùÈõ¢„ÇíË®àÁÆóÔºà„Ç™„Éï„Çª„ÉÉ„Éà‚Üí„Ç≠„É•„Éº„ÉñÊèõÁÆóÔºâ
function getHexDistance(cellA, cellB) {
  const a = getCellCoordinates(cellA);
  const b = getCellCoordinates(cellB);

  const dx = b.col - a.col;
  const dy = b.row - a.row - Math.floor((b.col - a.col + (a.col % 2)) / 2);
  const dz = -dx - dy;

  return Math.max(Math.abs(dx), Math.abs(dy), Math.abs(dz));
}

function highlightMovableCells(startCellNum, moveRange) {
  clearMoveHighlights();  // „Åæ„ÅöÂâçÂõû„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíÊ∂à„Åô

  const totalCells = MAP_ROWS * MAP_COLUMNS;
  for (let cellNum = 1; cellNum <= totalCells; cellNum++) {
    if (blockedCells.includes(cellNum)) continue;         // „Éñ„É≠„ÉÉ„ÇØ„Éû„Çπ„ÅØ„Çπ„Ç≠„ÉÉ„Éó
    if (occupiedCells.has(cellNum)) continue;             // „Åô„Åß„Å´‰ªñ„É¶„Éã„ÉÉ„Éà„Åå„ÅÑ„ÇãÂ†¥Âêà„ÇÇ„Çπ„Ç≠„ÉÉ„Éó

    const dist = getHexDistance(startCellNum, cellNum);
    if (dist <= moveRange) {
      const label = document.querySelector(`.hexLabel[data-cellnum="${cellNum}"]`);
      if (label) {
        label.classList.add("highlight-move");
        label.onclick = () => {
          moveUnitToCell(movingUnit, cellNum);
          clearMoveMode();
        };
      }
    }
  }
}
